name: Run Daily Bot

on:
  schedule:
    - cron: "0 20 * * *" # 日本時間 05:00
  workflow_dispatch:
    inputs:
      date:
        description: "日付 (YYYY-MM-DD形式、空欄で前日)"
        required: false
        type: string

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Set target date
        id: target_date
        run: |
          if [ -n "${{ inputs.date }}" ]; then
            echo "date=${{ inputs.date }}" >> $GITHUB_OUTPUT
          else
            # JSTで前日を計算
            DATE=$(TZ=Asia/Tokyo date -d "yesterday" +%F)
            echo "date=$DATE" >> $GITHUB_OUTPUT
          fi

      - name: Run Bot
        run: |
          docker run --rm \
            -e DISCORD_WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -e DATA_SOURCE_URL="${{ secrets.DATA_SOURCE_URL }}" \
            ghcr.io/${{ github.repository_owner }}/daily-hacker-news-bot:latest \
            ${{ steps.target_date.outputs.date }}
